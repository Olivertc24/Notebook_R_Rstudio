---
title: "M칩dulo 6: Visualizaci칩n Avanzada"
subtitle: "La Gram치tica de Gr치ficos con ggplot2"
author: "Prof. Oliver Trive침o"
format: 
  revealjs:
    theme: simple
    transition: slide
    slide-number: true
    logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/1b/R_logo.svg/724px-R_logo.svg.png"
    footer: "Visualizaci칩n con ggplot2"
    echo: true
    fig-width: 6
    fig-height: 4
editor: visual
lang: es
---

## La Filosof칤a `ggplot2`

-   ggplot2 es un sistema para crear gr치ficos de forma declarativa, basado en la "Gram치tica de Gr치ficos". Esto significa que construyes tus visualizaciones especificando componentes en lugar de los pasos exactos para dibujarlos.

-   A diferencia de Excel, aqu칤 no elegimos un "gr치fico de la galer칤a". Construimos el gr치fico por **capas**, como si estuvi칠ramos pintando un cuadro.

------------------------------------------------------------------------

La estructura b치sica es: $$Gr치fico = Datos + Est칠tica (aes) + Geometr칤a (geom)$$

-   Gram치tica de gr치ficos:

    -   Datos (data): El data frame con la informaci칩n que quieres visualizar.

    -   Mapeos est칠ticos (aes()): Define c칩mo las variables de tus datos se traducen en propiedades visuales (ejes x, y, color, tama침o, forma, etc.).

    -   Geometr칤as (geom\_\*): El tipo de gr치fico que quieres dibujar (puntos, l칤neas, barras, etc.).

------------------------------------------------------------------------

## Estructura B치sica de ggplot2

La estructura fundamental de un gr치fico en ggplot2 es simple:

-   

    1.  Empiezas con la funci칩n ggplot()

-   

    2.  Especificas los datos y los mapeos est칠ticos

-   

    3.  A침ade capas usando +.

``` r
ggplot(data = df, aes(x = var1, y = var2)) +
   geom_point()
```

------------------------------------------------------------------------

## Preparando los Datos

Vamos a simular una cartera de seguros de Autom칩vil para los ejemplos.

```{r}
#| message: false
library(tidyverse)
library(ggplot2)
library(scales)

# Semilla para reproducibilidad
set.seed(123)

cartera <- tibble(
  edad = sample(18:70, 120, replace = TRUE),
  tipo_auto = sample(c("Sedan", "SUV", "Deportivo"), 120, replace = T),
  prima = jitter(edad * 10 + sample(200:500, 120)),
  siniestro = sample(c(0, 1), 120, replace = TRUE, prob = c(0.8, 0.2)),
  mes = rep(seq(as.Date("2025-01-01"), by = "month", length.out = 12), times = 10)
) %>% 
  mutate(siniestro = as.factor(siniestro))
```

## 1. Dispersi칩n (Scatter Plot)

Relaci칩n entre dos variables num칠ricas.

**OJO**: Usamos + para agregar capas, no %\>%.

::::: columns
::: {.column width="50%"}
```{r}
#| label: scatter
#| eval: false
ggplot(data = cartera, 
       aes(x = edad, 
           y = prima)) +
  geom_point(color = "blue", 
             size = 3)
```

-   Data: cartera
-   Aes: x=edad, y=prima
-   Geom: Puntos
:::

::: {.column width="50%"}
```{r}
#| label: scatter-out
#| echo: false
ggplot(data = cartera, aes(x = edad, y = prima)) +
  geom_point(color = "blue", size = 3) + theme_minimal()
```
:::
:::::

------------------------------------------------------------------------

### Mapeo de Colores (Aesthetics)

쯏 si queremos que el color dependa de una variable (ej. Tipo de Auto)? Movemos color DENTRO de aes().

::::: columns
::: {.column width="45%"}
```{r}
#| label: aes-color
#| eval: false
ggplot(cartera, 
       aes(x = edad, 
           y = prima,
           color = tipo_auto)) +
  geom_point(size = 3)
```
:::

::: {.column width="55%"}
```{r}
#| label: aes-color-out
#| echo: false
ggplot(cartera, aes(x = edad, y = prima, color = tipo_auto)) +
  geom_point(size = 3) + theme_minimal(base_size = 14) + theme(legend.position="top")
```
:::
:::::

------------------------------------------------------------------------

## 2. Gr치ficos de Distribuci칩n

Vitales para actuarios: Histogramas y Boxplots.

### Histograma (Variable Num칠rica)

::::: columns
::: {.column width="40%"}
```{r}
#| label: hist
#| eval: false
ggplot(cartera, 
       aes(x = prima)) +
  geom_histogram(
    bins = 15,
    fill = "skyblue",
    color = "black"
  )
```
:::

::: {.column width="60%"}
```{r}
#| label: hist-out
#| echo: false
ggplot(cartera, aes(x = prima)) +
  geom_histogram(bins = 15, fill = "skyblue", color = "black") + theme_minimal()
```
:::
:::::

------------------------------------------------------------------------

### Densidad (Variable Num칠rica)

::::: columns
::: {.column width="40%"}
```{r}
#| label: dens
#| eval: false
ggplot(cartera, 
       aes(x = prima, 
           fill = tipo_auto )) +
  geom_density(alpha = 0.5) +
  labs(
    title = "Densidad de Primas por Tipo de Vehiculo", 
    x = "Prima (USD)", 
    y = "Densidad")
```
:::

::: {.column width="60%"}
```{r}
#| label: dens-out
#| echo: false
ggplot(cartera, 
       aes(x = prima, 
           fill = tipo_auto )) +
  geom_density(alpha = 0.5) +
  labs(
    title = "Densidad de Primas por Tipo de Vehiculo", 
    x = "Prima (USD)", 
    y = "Densidad")
```
:::
:::::

------------------------------------------------------------------------

### Boxplot (Num칠rica vs Categ칩rica)

Para ver dispersi칩n y outliers por grupo.

::::: columns
::: {.column width="40%"}
```{r}
#| label: box
#| eval: false
ggplot(cartera, 
       aes(x = tipo_auto, 
           y = prima,
           fill = tipo_auto)) +
  geom_boxplot()
```
:::

::: {.column width="60%"}
```{r}
#| label: box-out
#| echo: false
ggplot(cartera, 
       aes(x = tipo_auto, 
           y = prima,
           fill = tipo_auto)) +
  geom_boxplot()
```
:::
:::::

------------------------------------------------------------------------

### Lineas

Ideal para representar series temporales o la evoluci칩n de una variable a lo largo de otra continua ordenada.

::::: columns
::: {.column width="40%"}
```{r}
#| label: line
#| eval: false
# 1. Agrupamos y sumarizamos para obtener el total por mes
cartera_resumen <- cartera %>%
  group_by(mes) %>%
  summarise(total_prima = sum(prima))

# 2. Generamos el gr치fico
ggplot(cartera_resumen, aes(x = mes, y = total_prima)) +
  # Usamos geom_line y geom_point para ver la tendencia
  geom_line(color = "steelblue", linewidth = 1) + 
  geom_point(color = "darkred", size = 2) +
  # Ajustes de formato para el eje de fechas
  scale_x_date(date_labels = "%b", date_breaks = "1 month") +
  labs(
    title = "Evoluci칩n de Primas Cobradas",
    subtitle = "Total acumulado por mes - A침o 2025",
    x = "Mes",
    y = "Monto Total de Primas"
  )
```
:::

::: {.column width="60%"}
```{r}
#| label: line-out
#| echo: false
# 1. Agrupamos y sumarizamos para obtener el total por mes
cartera_resumen <- cartera %>%
  group_by(mes) %>%
  summarise(total_prima = sum(prima))

# 2. Generamos el gr치fico
ggplot(cartera_resumen, aes(x = mes, y = total_prima)) +
  # Usamos geom_line y geom_point para ver la tendencia
  geom_line(color = "steelblue", linewidth = 1) + 
  geom_point(color = "darkred", size = 2) +
  # Ajustes de formato para el eje de fechas
  scale_x_date(date_labels = "%b", date_breaks = "1 month") +
  labs(
    title = "Evoluci칩n de Primas Cobradas",
    subtitle = "Total acumulado por mes - A침o 2025",
    x = "Mes",
    y = "Monto Total de Primas"
  )
```
:::
:::::

------------------------------------------------------------------------

## Personalizaci칩n

### Etiquetas y T칤tulos (labs())

labs() permite a침adir y modificar f치cilmente t칤tulos, subt칤tulos, pies de p치gina y etiquetas de ejes.

``` r
labs
     title = "Evoluci칩n de Primas Cobradas",
     subtitle = "Total acumulado por mes - A침o 2025",
     x = "Mes",
     y = "Monto Total de Primas",
     caption = "Fuente de Datos: Elaboraci칩n Propia"
```

------------------------------------------------------------------------

## Personalizaci칩n

### Temas (theme\_\*())

``` r
Temas predefinidos: theme_minimal(), theme_bw(), theme_classic(), theme_light(), etc., cambian r치pidamente la apariencia general del gr치fico.

* Ajustes manuales con theme(): Permite un control granular sobre cada elemento del tema (texto, l칤neas, fondos, leyendas).
```

------------------------------------------------------------------------

## Personalizaci칩n

### Escalas (scale\_\*())

``` r
Las escalas controlan c칩mo los datos se mapean a los est칠ticos.

Ejes: scale_x_continuous(), scale_y_log10(), scale_x_date(), etc., para controlar rangos, breaks, transformaciones.

Colores/Rellenos: scale_color_manual(), scale_fill_brewer(), scale_fill_viridis_d(), etc., para definir paletas de colores o asignaciones manuales.
```

------------------------------------------------------------------------

## Personalizaci칩n

### Facetas (facet_wrap() y facet_grid())

``` r
 Dividen el gr치fico en m칰ltiples paneles (o "facetas") basados en una o dos variables categ칩ricas.

   facet_wrap(~ var): Una dimensi칩n, envuelve los paneles en filas/columnas.

   facet_grid(var_fila ~ var_columna): Dos dimensiones, crea una cuadr칤cula de paneles.
```

------------------------------------------------------------------------

### Ejemplo Personalizaci칩n

```{r}
#| label: pers
#| eval: false
# --- 1. Preparaci칩n de los datos ---
cartera_grafico <- cartera %>%
  group_by(mes, tipo_auto, siniestro) %>%
  summarise(monto_primas = sum(prima), .groups = "drop") %>%
  mutate(siniestro_label = ifelse(siniestro == 1, "Con Siniestro", "Sin Siniestro"))

# --- 2. Gr치fico ---
ggplot(cartera_grafico, aes(x = mes, y = monto_primas, fill = siniestro_label)) +
  
  # --- Geometr칤as ---
  # width = 20 ajusta el ancho de las barras (d칤as) para que no se toquen entre meses
  geom_col(width = 20, color = "white", alpha = 0.9) + 
  
  # --- Facetas ---
  facet_wrap(~tipo_auto, scales = "free_y") +
  
  # --- Escalas ---
  scale_y_continuous(
    labels = scales::dollar_format(prefix = "$", big.mark = ","),
    # expansion a침ade un 15% extra arriba para que las etiquetas o barras no toquen el techo
    expand = expansion(mult = c(0, 0.15)) 
  ) +
  scale_x_date(
    date_labels = "%b", 
    date_breaks = "1 month"
  ) +
  scale_fill_manual(
    values = c("Sin Siniestro" = "#2C3E50", "Con Siniestro" = "#E74C3C")
  ) +
  
  # --- Etiquetas ---
  labs(
    title = "An치lisis de Primas Emitidas por Segmento",
    subtitle = "Comparativa mensual de p칩lizas seg칰n estado de siniestralidad",
    x = NULL,
    y = "Primas Cobradas (USD)",
    fill = "Estado de P칩liza",
    caption = paste0("Fuente: Datos simulados | Ejecuci칩n: ", Sys.Date())
  ) +
  
  # --- Tema Personalizado ---
  theme_minimal(base_size = 12) +
  theme(
    # T칤tulos y Textos (Usando element_text nativo)
    plot.title = element_text(face = "bold", size = 16, color = "#2c3e50", hjust = 0),
    plot.subtitle = element_text(size = 12, color = "grey40", margin = margin(b = 10)),
    plot.caption = element_text(color = "grey60", face = "italic", margin = margin(t = 15)),
    
    # Leyenda movida abajo para dar m치s espacio al gr치fico
    legend.position = "bottom",
    legend.title = element_text(face = "bold", size = 10),
    
    # Estilo de las facetas (Cajitas grises arriba de cada gr치fico)
    strip.background = element_rect(fill = "#ECF0F1", color = NA),
    strip.text = element_text(face = "bold", color = "#2C3E50", size = 11),
    
    # Limpieza de Ejes
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10), # Rotaci칩n para leer los meses
    axis.line.x = element_line(color = "grey80"), # L칤nea sutil en el eje X
    panel.grid.minor = element_blank(), # Eliminar cuadr칤cula menor
    panel.grid.major.x = element_blank() # Eliminar l칤neas verticales para limpieza visual
  )
```

------------------------------------------------------------------------

### Ejemplo Personalizaci칩n

```{r}
#| label: pers-out
#| echo: false
# --- 1. Preparaci칩n de los datos ---
cartera_grafico <- cartera %>%
  group_by(mes, tipo_auto, siniestro) %>%
  summarise(monto_primas = sum(prima), .groups = "drop") %>%
  mutate(siniestro_label = ifelse(siniestro == 1, "Con Siniestro", "Sin Siniestro"))

# --- 2. Gr치fico ---
ggplot(cartera_grafico, aes(x = mes, y = monto_primas, fill = siniestro_label)) +
  
  # --- Geometr칤as ---
  # width = 20 ajusta el ancho de las barras (d칤as) para que no se toquen entre meses
  geom_col(width = 20, color = "white", alpha = 0.9) + 
  
  # --- Facetas ---
  facet_wrap(~tipo_auto, scales = "free_y") +
  
  # --- Escalas ---
  scale_y_continuous(
    labels = scales::dollar_format(prefix = "$", big.mark = ","),
    # expansion a침ade un 15% extra arriba para que las etiquetas o barras no toquen el techo
    expand = expansion(mult = c(0, 0.15)) 
  ) +
  scale_x_date(
    date_labels = "%b", 
    date_breaks = "1 month"
  ) +
  scale_fill_manual(
    values = c("Sin Siniestro" = "#2C3E50", "Con Siniestro" = "#E74C3C")
  ) +
  
  # --- Etiquetas ---
  labs(
    title = "An치lisis de Primas Emitidas por Segmento",
    subtitle = "Comparativa mensual de p칩lizas seg칰n estado de siniestralidad",
    x = NULL,
    y = "Primas Cobradas (USD)",
    fill = "Estado de P칩liza",
    caption = paste0("Fuente: Datos simulados | Ejecuci칩n: ", Sys.Date())
  ) +
  
  # --- Tema Personalizado ---
  theme_minimal(base_size = 12) +
  theme(
    # T칤tulos y Textos (Usando element_text nativo)
    plot.title = element_text(face = "bold", size = 16, color = "#2c3e50", hjust = 0),
    plot.subtitle = element_text(size = 12, color = "grey40", margin = margin(b = 10)),
    plot.caption = element_text(color = "grey60", face = "italic", margin = margin(t = 15)),
    
    # Leyenda movida abajo para dar m치s espacio al gr치fico
    legend.position = "bottom",
    legend.title = element_text(face = "bold", size = 10),
    
    # Estilo de las facetas (Cajitas grises arriba de cada gr치fico)
    strip.background = element_rect(fill = "#ECF0F1", color = NA),
    strip.text = element_text(face = "bold", color = "#2C3E50", size = 11),
    
    # Limpieza de Ejes
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10), # Rotaci칩n para leer los meses
    axis.line.x = element_line(color = "grey80"), # L칤nea sutil en el eje X
    panel.grid.minor = element_blank(), # Eliminar cuadr칤cula menor
    panel.grid.major.x = element_blank() # Eliminar l칤neas verticales para limpieza visual
  )
```

::: {style="position: fixed; bottom: 30px; right: 30px; z-index: 1000;"}
<a href="../index.qmd" class="btn btn-primary shadow-lg" role="button" style="border-radius: 50px; padding: 10px 20px;"> 游 Inicio </a>
:::
